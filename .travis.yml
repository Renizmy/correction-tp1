language: java
dist: xenial

  
addons:
  sonarcloud:
    organization: "renizmy"
    token: "$SONARCLOUD_TOKEN"

install:
  - pip install ansible
  - pip install ansible-vault
    
jobs:
  include:
    - stage: dev
      if: branch = develop OR master
      script: bash scripts/build.sh
    - stage: prod
      if: branch = develop OR master
      script: bash scripts/docker.sh

    - stage : deploy
      if: branch = master
      env:
        - ANSIBLE_HOST_KEY_CHECKING=false
      script:
        - ansible-vault view encrypted/id_rsa_encrypted >> id_rsa
        - chmod 400 id_rsa
        - ansible-playbook -i ansible/inventories/setup.yml ansible/playbook.yml

branches:
  only:
    - develop

cache:
  directories:
   - $HOME/.m2
    
services:
  - docker


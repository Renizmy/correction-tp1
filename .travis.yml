language: java
dist: xenial

  
addons:
  sonarcloud:
    organization: "renizmy"
    token: "$SONARCLOUD_TOKEN"

install:
  - pip install ansible
  - pip install ansible-vault
    
jobs:
  include:
  #  - stage: dev
  #    if: branch = develop # OR main
  #    script: bash scripts/build.sh
  #  - stage: prod
  #    if: branch = develop  # OR main
  #    script: bash scripts/docker.sh

    - stage : deploy
      if: branch = main
      env:
        - ANSIBLE_HOST_KEY_CHECKING=false
        - ANSIBLE_VAULT_PASSWORD_FILE=ansible/.vault_pass
      script:
       - touch ansible/.vault_pass
       - echo $vault_pass >> ansible/.vault_pass
       - a=$(pwd)
       - echo $a
       - touch ansible/id_rsa
       - chmod 600 ansible/key/id_rsa_encrypted
       - chmod 600 ansible/id_rsa
       - ansible-vault view ansible/key/id_rsa_encrypted >> ansible/id_rsa
       - chmod 400 ansible/id_rsa
       - ansible-playbook -i ansible/inventories/setup.yml ansible/playbook.yml


cache:
  directories:
   - $HOME/.m2
    
services:
  - docker

